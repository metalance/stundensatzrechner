/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['./InputBase','./ComboBoxTextField','./ComboBoxBase','./Input','./Tokenizer','./Token','./ToggleButton','./List','./StandardListItem','./Popover','./Toolbar','./GroupHeaderListItem','./library','sap/ui/core/EnabledPropagator','sap/ui/core/IconPool','sap/ui/core/library','sap/ui/Device','sap/ui/core/Item','sap/ui/core/SeparatorItem','sap/ui/core/ResizeHandler','./MultiComboBoxRenderer',"sap/ui/dom/containsOrEquals","sap/ui/events/KeyCodes","sap/base/util/deepEqual","sap/base/assert","sap/base/Log","sap/ui/core/Core","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/cursorPos","sap/ui/dom/jquery/control"],function(I,C,a,b,T,c,d,L,S,P,e,G,l,E,f,g,D,h,j,R,M,k,K,m,n,o,p,q){"use strict";var r=l.ListType;var s=l.ListMode;var V=g.ValueState;var O=g.OpenState;var t=l.PlacementType;var u=a.extend("sap.m.MultiComboBox",{metadata:{library:"sap.m",designtime:"sap/m/designtime/MultiComboBox.designtime",properties:{selectedKeys:{type:"string[]",group:"Data",defaultValue:[]}},associations:{selectedItems:{type:"sap.ui.core.Item",multiple:true,singularName:"selectedItem"}},events:{selectionChange:{parameters:{changedItem:{type:"sap.ui.core.Item"},selected:{type:"boolean"}}},selectionFinish:{parameters:{selectedItems:{type:"sap.ui.core.Item[]"}}}},dnd:{draggable:false,droppable:true}}});f.insertFontFaceStyle();E.apply(u.prototype,[true]);u.prototype.open=function(){this._bPickerIsOpening=true;return a.prototype.open.apply(this,arguments);};u.prototype.onsapend=function(i){sap.m.Tokenizer.prototype.onsapend.apply(this._oTokenizer,arguments);};u.prototype.onsaphome=function(i){sap.m.Tokenizer.prototype.onsaphome.apply(this._oTokenizer,arguments);};u.prototype.onsapdown=function(i){if(!this.getEnabled()||!this.getEditable()){return;}i.setMarked();i.preventDefault();var v=this.getSelectableItems();var w=v[0];if(w&&this.isOpen()){this.getListItem(w).focus();return;}if(this._oTokenizer.getSelectedTokens().length){return;}this._oTraversalItem=this._getNextTraversalItem();if(this._oTraversalItem){this.updateDomValue(this._oTraversalItem.getText());this.selectText(0,this.getValue().length);}};u.prototype.onsapup=function(i){if(!this.getEnabled()||!this.getEditable()){return;}i.setMarked();i.preventDefault();if(this._oTokenizer.getSelectedTokens().length){return;}this._oTraversalItem=this._getPreviousTraversalItem();if(this._oTraversalItem){this.updateDomValue(this._oTraversalItem.getText());this.selectText(0,this.getValue().length);}};u.prototype.onsapshow=function(i){var v=this._getList(),w=this.getPicker(),x=this.getSelectableItems(),y=this.getSelectedItems(),z,A=v.getItemNavigation(),B,F;F=q(document.activeElement).control()[0];if(F instanceof sap.m.Token){z=this._getItemByToken(F);}else{z=y.length?this._getItemByListItem(this._getList().getSelectedItems()[0]):x[0];}B=this.getItems().indexOf(z);if(A){A.setSelectedIndex(B);}else{this._bListItemNavigationInvalidated=true;this._iInitialItemFocus=B;}w.setInitialFocus(v);a.prototype.onsapshow.apply(this,arguments);};u.prototype.onsaphide=u.prototype.onsapshow;u.prototype._selectItemByKey=function(v){var w,x,y,i,z,A=this.isOpen();if(!this.getEnabled()||!this.getEditable()){return;}if(v){v.setMarked();}w=this._getUnselectedItems(A?"":this.getValue());for(i=0;i<w.length;i++){if(w[i].getText().toUpperCase()===this.getValue().toUpperCase()){y=w[i];z=true;break;}}if(z){x={item:y,id:y.getId(),key:y.getKey(),fireChangeEvent:true,fireFinishEvent:true,suppressInvalidate:true,listItemUpdated:false};this._bPreventValueRemove=false;if(this.getValue()===""||(typeof this.getValue()==="string"&&y.getText().toLowerCase().startsWith(this.getValue().toLowerCase()))){if(this.getListItem(y).isSelected()){this.setValue('');}else{this.setSelection(x);}}}else{if(this.isPickerDialog()){this._showAlreadySelectedVisualEffect();}this._bPreventValueRemove=true;this._showWrongValueVisualEffect();}if(v){this.close();}};u.prototype.onsapenter=function(i){I.prototype.onsapenter.apply(this,arguments);this._showAlreadySelectedVisualEffect();if(this.getValue()){this._selectItemByKey(i);}};u.prototype.onsaptabnext=function(i){var v=this.getValue();if(v){var w=this._getUnselectedItemsStartingText(v);if(w.length===1){this._selectItemByKey(i);}else{this._showWrongValueVisualEffect();}}};u.prototype.onsapfocusleave=function(i){var v=this.getAggregation("picker"),w=this.isPlatformTablet(),x=p.byId(i.relatedControlId),F=x&&x.getFocusDomRef(),y=this.getValue();if(!this._bPickerIsOpening&&(!v||!v.getFocusDomRef()||!F||!q.contains(v.getFocusDomRef(),F))){this.setValue(null);if(y){this.fireChangeEvent("",{value:y});}if(!(x instanceof c||i.srcControl instanceof c)){this._oTokenizer.scrollToEnd();}if(!q.contains(this.getDomRef(),document.activeElement)){this._oTokenizer._useCollapsedMode(true);}}if(v&&F){if(m(v.getFocusDomRef(),F)&&!w&&!this.isPickerDialog()){this.focus();}}};u.prototype.onfocusin=function(i){var v=this.getPicker();var w=false;var x=v.getFocusDomRef();var y=v.oPopup.getOpenState();var z=y===O.CLOSING||y===O.CLOSED;var A=this.getPickerType()==="Dropdown";if(A){w=x&&q.contains(x,i.relatedTarget);}if(this.getEditable()){this._oTokenizer._useCollapsedMode(false);this._oTokenizer.scrollToEnd();}if(i.target===this.getFocusDomRef()){this.getEditable()&&this.addStyleClass("sapMFocus");!z&&w&&this.handleInputValidation(i,false);}if(i.target===this.getOpenArea()&&A&&!this.isPlatformTablet()){this.focus();}if(!this.isOpen()&&this.shouldValueStateMessageBeOpened()){this.openValueStateMessage();}};u.prototype._handleItemTap=function(i){var v=q(i.target).control(0);if(!v.isA("sap.m.CheckBox")&&!v.isA("sap.m.GroupHeaderListItem")){this._bCheckBoxClicked=false;}};u.prototype._handleItemPress=function(i){if(this.isOpen()&&this._isListInSuggestMode()&&this.getPicker().oPopup.getOpenState()!==O.CLOSING){this.clearFilter();var v=this._getLastSelectedItem();if(v){this.getListItem(v).focus();}}};u.prototype._handleSelectionLiveChange=function(i){var v=i.getParameter("listItem");var w=i.getParameter("selected");var N=this._getItemByListItem(v);var x=this.isPickerDialog()?this.getPickerTextField():this;if(v.getType()==="Inactive"){return;}n(N,"The corresponding mapped item was not found on "+this);if(!N){return;}var y={item:N,id:N.getId(),key:N.getKey(),fireChangeEvent:true,suppressInvalidate:true,listItemUpdated:true};if(w){this.fireChangeEvent(N.getText());this.setSelection(y);}else{this.fireChangeEvent(N.getText());this.removeSelection(y);}if(this._bCheckBoxClicked){x.setValue(this._sOldInput);if(this.isOpen()&&this.getPicker().oPopup.getOpenState()!==O.CLOSING){v.focus();}}else{this._bCheckBoxClicked=true;this.setValue("");this.close();}};u.prototype.onkeydown=function(i){a.prototype.onkeydown.apply(this,arguments);if(!this.getEnabled()||!this.getEditable()){return;}this._bIsPasteEvent=(i.ctrlKey||i.metaKey)&&(i.which===K.V);if(this.getValue().length===0&&(i.ctrlKey||i.metaKey)&&(i.which===K.A)&&this._hasTokens()){this._oTokenizer.focus();this._oTokenizer.selectAllTokens(true);i.preventDefault();}if(this.isPickerDialog()){this._sOldValue=this.getPickerTextField().getValue();this._iOldCursorPos=q(this.getFocusDomRef()).cursorPos();}this._bDoTypeAhead=(i.which!==K.BACKSPACE)&&(i.which!==K.DELETE);};u.prototype.oninput=function(i){a.prototype.oninput.apply(this,arguments);var v=i.srcControl,w=this.getPickerTextField();if(this.isPickerDialog()&&w.getValueState()===V.Error){w.setValueState(V.None);}if(!this.getEnabled()||!this.getEditable()){return;}if(this._bIsPasteEvent){v.updateDomValue(this._sOldValue||"");return;}this.handleInputValidation(i,this.isComposingCharacter());if(this.isOpen()){setTimeout(this._highlightList.bind(this,this._sOldInput));}};u.prototype.filterItems=function(i){var F=this.fnFilter?this.fnFilter:a.DEFAULT_TEXT_FILTER;var v=[];var w=false;var x=[];i.items.forEach(function(y){if(y.isA("sap.ui.core.SeparatorItem")){x.push({separator:y});this.getListItem(y).setVisible(false);w=true;return;}var z=!!F(i.value,y,"getText");if(i.value===""){z=true;if(!this.bOpenedByKeyboardOrButton&&!this.isPickerDialog()){return;}}if(w&&z){this.getListItem(x[x.length-1].separator).setVisible(true);}var A=this.getListItem(y);if(A){A.setVisible(z);z&&v.push(y);}},this);return v;};u.prototype.onkeyup=function(i){if(!this.getEnabled()||!this.getEditable()){return;}this._sOldValue=this.getValue();this._iOldCursorPos=q(this.getFocusDomRef()).cursorPos();};u.prototype._showWrongValueVisualEffect=function(){var i=this.getPickerTextField(),v=this.isPickerDialog()?i.getValueState():this.getValueState(),w=this._oRbC.getText("VALUE_STATE_ERROR");if(v===V.Error){return;}if(this.isPickerDialog()){i.setValueState(V.Error);i.setValueStateText(w);setTimeout(i["setValueState"].bind(i,v),1000);}else{this.setValueState(V.Error);this.setValueStateText(w);setTimeout(this["setValueState"].bind(this,v),1000);}};u.prototype._showAlreadySelectedVisualEffect=function(){var i=this.isPickerDialog(),v=this.getPickerTextField(),w=i?v.getValueState():this.getValueState(),x=this.getValue().toLowerCase(),y=this.getSelectedItems().map(function(z){return z.getText().toLowerCase();}),A=this._oRbM.getText("VALUE_STATE_ERROR_ALREADY_SELECTED");if(y.indexOf(x)>-1&&w!==V.Error){if(i){v.setValueState(V.Error);v.setValueStateText(A);v.selectText(0,this.getValue().length);}else{this.setValueState(V.Error);this.setValueStateText(A);this.selectText(0,this.getValue().length);}}else{i?v.setValueState(V.None):this.setValueState(V.None);}};u.prototype._getReadOnlyPopover=function(){if(!this._oReadOnlyPopover){this._oReadOnlyPopover=this._createReadOnlyPopover();}return this._oReadOnlyPopover;};u.prototype._createReadOnlyPopover=function(){return new P({showArrow:true,placement:t.Auto,showHeader:false,contentMinWidth:"auto"}).addStyleClass("sapMMultiComboBoxReadOnlyPopover");};u.prototype.configPicker=function(i){var v=this.getRenderer(),w=v.CSS_CLASS_MULTICOMBOBOX;i.setHorizontalScrolling(false).addStyleClass(v.CSS_CLASS_COMBOBOXBASE+"Picker").addStyleClass(w+"Picker").addStyleClass(w+"Picker-CTX").attachBeforeOpen(this.onBeforeOpen,this).attachAfterOpen(this.onAfterOpen,this).attachBeforeClose(this.onBeforeClose,this).attachAfterClose(this.onAfterClose,this).addEventDelegate({onBeforeRendering:this.onBeforeRenderingPicker,onAfterRendering:this.onAfterRenderingPicker},this);};u.prototype._configureList=function(i){var v=this.getRenderer();if(!i){return;}i.setMode(s.MultiSelect).setIncludeItemInSelection(true).setRememberSelections(false).addStyleClass(v.CSS_CLASS_COMBOBOXBASE+"List").addStyleClass(v.CSS_CLASS_MULTICOMBOBOX+"List");i.attachBrowserEvent("tap",this._handleItemTap,this).attachSelectionChange(this._handleSelectionLiveChange,this).attachItemPress(this._handleItemPress,this);i.addEventDelegate({onAfterRendering:this.onAfterRenderingList,onfocusin:this.onFocusinList},this);};u.prototype.createPickerTextField=function(){var i=this;return new b({submit:function(v){var w=this.getValue();if(w){i.setValue(w);i._selectItemByKey();this.setValue(i._sOldInput);i.close();}}}).addEventDelegate({onfocusout:this._handleInputFocusOut},this);};u.prototype.onBeforeRendering=function(){a.prototype.onBeforeRendering.apply(this,arguments);var i=this.getItems(),v=this._getList();if(v){this._synchronizeSelectedItemAndKey(i);v.destroyItems();this._clearTokenizer();this._fillList(i);if(v.getItemNavigation()){this._iFocusedIndex=v.getItemNavigation().getFocusedIndex();}this.setEditable(this.getEditable());}this._deregisterResizeHandler();};u.prototype._registerResizeHandler=function(){n(!this._iResizeHandlerId,"Resize handler already registered");this._iResizeHandlerId=R.register(this,this._onResize.bind(this));};u.prototype._deregisterResizeHandler=function(){if(this._iResizeHandlerId){R.deregister(this._iResizeHandlerId);this._iResizeHandlerId=null;}};u.prototype._onResize=function(){this._oTokenizer.setMaxWidth(this._calculateSpaceForTokenizer());};u.prototype.onBeforeRenderingPicker=function(){var i=this["_onBeforeRendering"+this.getPickerType()];if(i){i.call(this);}};u.prototype.onAfterRenderingPicker=function(){var i=this["_onAfterRendering"+this.getPickerType()];if(i){i.call(this);}};u.prototype.onBeforeOpen=function(){var i=this["_onBeforeOpen"+this.getPickerType()];this.addStyleClass(I.ICON_PRESSED_CSS_CLASS);this._resetCurrentItem();this.addContent();this._aInitiallySelectedItems=this.getSelectedItems();this._synchronizeSelectedItemAndKey(this._aInitiallySelectedItems);if(i){i.call(this);}};u.prototype.onAfterOpen=function(){var i=this.getFocusDomRef();i&&this.getRoleComboNodeDomRef().setAttribute("aria-expanded","true");this._bPickerIsOpening=false;if(!this.isPlatformTablet()){this.getPicker().setInitialFocus(this);}this.closeValueStateMessage();};u.prototype.onBeforeClose=function(){a.prototype.onBeforeClose.apply(this,arguments);};u.prototype.onAfterClose=function(){var U=!q.contains(this.getDomRef(),document.activeElement)||this.isPickerDialog(),i=this.getFocusDomRef();i&&this.getRoleComboNodeDomRef().setAttribute("aria-expanded","false");this.removeStyleClass(I.ICON_PRESSED_CSS_CLASS);this.clearFilter();!this.isComposingCharacter()&&!this._bPreventValueRemove&&this.setValue("");this._sOldValue="";this._sOldInput="";if(this.isPickerDialog()){this._showAlreadySelectedVisualEffect();this.getPickerTextField().setValue("");this._getFilterSelectedButton()&&this._getFilterSelectedButton().setPressed(false);}this.fireSelectionFinish({selectedItems:this.getSelectedItems()});this._oTokenizer._useCollapsedMode(U);if(this.getValueState()==V.Error&&document.activeElement===this.getFocusDomRef()){this.selectText(0,this.getValue().length);this.openValueStateMessage();}};u.prototype._onBeforeOpenDialog=function(){};u.prototype._onBeforeOpenDropdown=function(){var i=this.getPicker(),v=this.getDomRef(),w;if(v&&i){w=(v.offsetWidth/parseFloat(l.BaseFontSize))+"rem";i.setContentMinWidth(w);}};u.prototype.configureDropdown=function(i){i.setInitialFocus(this);};u.prototype.getFilterSelectedButton=function(){if(this._oToggleButton){return this._oToggleButton;}this._oToggleButton=this._createFilterSelectedButton();return this._oToggleButton;};u.prototype.getPickerCustomHeader=function(){if(this._oPickerCustomHeader){return this._oPickerCustomHeader;}this._oPickerCustomHeader=this.createPickerHeader();return this._oPickerCustomHeader;};u.prototype.getCustomHeaderToolbar=function(){if(this._oCustomHeaderToolbar){return this._oCustomHeaderToolbar;}this._oCustomHeaderToolbar=new e();return this._oCustomHeaderToolbar;};u.prototype.getPickerCloseButton=function(){if(this._oPickerCloseButton){return this._oPickerCloseButton;}this._oPickerCloseButton=this.createPickerCloseButton();return this._oPickerCloseButton;};u.prototype.configureDialog=function(i){var v=this,w=this.getFilterSelectedButton(),x=this._oSuggestionPopover._oPopupInput,y=this.getCustomHeaderToolbar(),z=this.getPickerInvisibleTextId();y.addContent(x);this.setTextFieldHandler(x);i.setStretch(true);i.setCustomHeader(this.getPickerCustomHeader());i.setSubHeader(y);i.addButton(this.createPickerCloseButton());i.getSubHeader().addContent(w);i.attachBeforeOpen(function(){v.updatePickerHeaderTitle();});i.attachAfterClose(function(){v.focus();l.closeKeyboard();});if(z){i.addAriaLabelledBy(z);}};u.prototype._createFilterSelectedButton=function(){if(this._oToggleButton){return this._oToggleButton;}var i=f.getIconURI("multiselect-all"),v=this.getRenderer(),w=this;this._oToggleButton=new d({icon:i,press:w._filterSelectedItems.bind(this)}).addStyleClass(v.CSS_CLASS_MULTICOMBOBOX+"ToggleButton");return this._oToggleButton;};u.prototype._getFilterSelectedButton=function(){return this.getPicker().getSubHeader().getContent()[1];};u.prototype._filterSelectedItems=function(i,F){var v=i.oSource,w,x,y=this.getPickerTextField()?this.getPickerTextField().getValue():"",z=(v&&v.getPressed&&v.getPressed())||F,A=this.getVisibleItems(),B=this.getItems(),H=this.getSelectedItems(),J=null;if(z){A.forEach(function(N){x=H.indexOf(N)>-1?true:false;w=this.getListItem(N);if(!w){return;}if(w.isA("sap.m.GroupHeaderListItem")){w.setVisible(false);J=w;}else{w.setVisible(x);if(x&&J){J.setVisible(true);}}},this);}else{this.filterItems({value:y,items:B});}};u.prototype.revertSelection=function(){this.setSelectedItems(this._aInitiallySelectedItems);};u.prototype.setSelection=function(i){if(i.item&&this.isItemSelected(i.item)){return;}if(!i.item){return;}if(!i.listItemUpdated&&this.getListItem(i.item)){this._getList().setSelectedItem(this.getListItem(i.item),true);}var v=new c({key:i.key});v.setText(i.item.getText());i.item.data(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Token",v);this._oTokenizer.addToken(v);this.$().toggleClass("sapMMultiComboBoxHasToken",this._hasTokens());this.setValue('');this.addAssociation("selectedItems",i.item,i.suppressInvalidate);var w=this.getKeys(this.getSelectedItems());this.setProperty("selectedKeys",w,i.suppressInvalidate);if(i.fireChangeEvent){this.fireSelectionChange({changedItem:i.item,selected:true});}if(i.fireFinishEvent){if(!this.isOpen()){this.fireSelectionFinish({selectedItems:this.getSelectedItems()});}}};u.prototype.removeSelection=function(i){if(i.item&&!this.isItemSelected(i.item)){return;}if(!i.item){return;}this.removeAssociation("selectedItems",i.item,i.suppressInvalidate);var v=this.getKeys(this.getSelectedItems());this.setProperty("selectedKeys",v,i.suppressInvalidate);if(!i.listItemUpdated&&this.getListItem(i.item)){var w=this.getListItem(i.item);this._getList().setSelectedItem(w,false);}if(!i.tokenUpdated){var x=this._getTokenByItem(i.item);i.item.data(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Token",null);this._oTokenizer.removeToken(x);}this.$().toggleClass("sapMMultiComboBoxHasToken",this._hasTokens());if(i.fireChangeEvent){this.fireSelectionChange({changedItem:i.item,selected:false});}if(i.fireFinishEvent){if(!this.isOpen()){this.fireSelectionFinish({selectedItems:this.getSelectedItems()});}}};u.prototype._synchronizeSelectedItemAndKey=function(v){if(!v.length){o.info("Info: _synchronizeSelectedItemAndKey() the MultiComboBox control does not contain any item on ",this);return;}var w=this.getSelectedKeys()||this._aCustomerKeys;var x=this.getKeys(this.getSelectedItems());if(w.length){for(var i=0,y=null,z=null,A=null,B=w.length;i<B;i++){y=w[i];if(x.indexOf(y)>-1){if(this._aCustomerKeys.length&&(A=this._aCustomerKeys.indexOf(y))>-1){this._aCustomerKeys.splice(A,1);}continue;}z=this.getItemByKey(""+y);if(z){if(this._aCustomerKeys.length&&(A=this._aCustomerKeys.indexOf(y))>-1){this._aCustomerKeys.splice(A,1);}this.setSelection({item:z,id:z.getId(),key:z.getKey(),fireChangeEvent:false,suppressInvalidate:true,listItemUpdated:false});}}return;}};u.prototype._getTokenByItem=function(i){return i?i.data(this.getRenderer().CSS_CLASS_COMBOBOXBASE+"Token"):null;};u.prototype.updateItems=function(i){var v,w,x=this.getSelectedKeys();var U=a.prototype.updateItems.apply(this,arguments);w=this.getSelectedItems();v=(w.length===x.length)&&w.every(function(y){return y&&y.getKey&&x.indexOf(y.getKey())>-1;});if(!v){w=x.map(this.getItemByKey,this);this.setSelectedItems(w);}return U;};u.prototype._getSelectedItemsOf=function(v){for(var i=0,w=v.length,x=[];i<w;i++){if(this.getListItem(v[i]).isSelected()){x.push(v[i]);}}return x;};u.prototype._getLastSelectedItem=function(){var i=this._oTokenizer.getTokens();var v=i.length?i[i.length-1]:null;if(!v){return null;}return this._getItemByToken(v);};u.prototype._getOrderedSelectedItems=function(){var v=[];for(var i=0,w=this._oTokenizer.getTokens(),x=w.length;i<x;i++){v[i]=this._getItemByToken(w[i]);}return v;};u.prototype._getFocusedListItem=function(){if(!document.activeElement){return null;}var F=p.byId(document.activeElement.id);if(this._getList()&&k(this._getList().getFocusDomRef(),F.getFocusDomRef())){return F;}return null;};u.prototype._getFocusedItem=function(){var i=this._getFocusedListItem();return this._getItemByListItem(i);};u.prototype._isRangeSelectionSet=function(i){var $=i.getDomRef();return $.indexOf(this.getRenderer().CSS_CLASS_MULTICOMBOBOX+"ItemRangeSelection")>-1?true:false;};u.prototype._hasTokens=function(){return this._oTokenizer.getTokens().length>0;};u.prototype._getCurrentItem=function(){if(!this._oCurrentItem){return this._getFocusedItem();}return this._oCurrentItem;};u.prototype._setCurrentItem=function(i){this._oCurrentItem=i;};u.prototype._resetCurrentItem=function(){this._oCurrentItem=null;};u.prototype._decorateListItem=function(i){i.addDelegate({onkeyup:function(v){var w=null;if(v.which==K.SPACE&&this.isOpen()&&this._isListInSuggestMode()){this.open();w=this._getLastSelectedItem();if(w){this.getListItem(w).focus();}return;}},onkeydown:function(v){var w=null,x=null;if(v.shiftKey&&v.which==K.ARROW_DOWN){x=this._getCurrentItem();w=this._getNextVisibleItemOf(x);}if(v.shiftKey&&v.which==K.ARROW_UP){x=this._getCurrentItem();w=this._getPreviousVisibleItemOf(x);}if(v.shiftKey&&v.which===K.SPACE){x=this._getCurrentItem();this._selectPreviousItemsOf(x);}if(w&&w!==x){if(this.getListItem(x).isSelected()){this.setSelection({item:w,id:w.getId(),key:w.getKey(),fireChangeEvent:true,suppressInvalidate:true});this._setCurrentItem(w);}else{this.removeSelection({item:w,id:w.getId(),key:w.getKey(),fireChangeEvent:true,suppressInvalidate:true});this._setCurrentItem(w);}return;}this._resetCurrentItem();if((v.ctrlKey||v.metaKey)&&v.which==K.A){v.setMarked();v.preventDefault();var y=this.getSelectableItems();var z=this._getSelectedItemsOf(y);if(z.length!==y.length){y.forEach(function(w){this.setSelection({item:w,id:w.getId(),key:w.getKey(),fireChangeEvent:true,suppressInvalidate:true,listItemUpdated:false});},this);}else{y.forEach(function(w){this.removeSelection({item:w,id:w.getId(),key:w.getKey(),fireChangeEvent:true,suppressInvalidate:true,listItemUpdated:false});},this);}}}},true,this);i.addEventDelegate({onsapbackspace:function(v){v.preventDefault();},onsapshow:function(v){v.setMarked();if(this.isOpen()){this.close();return;}if(this.hasContent()){this.open();}},onsaphide:function(v){this.onsapshow(v);},onsapenter:function(v){v.setMarked();this.close();},onsaphome:function(v){v.setMarked();v.preventDefault();var w=this.getSelectableItems();var x=w[0];this.getListItem(x).focus();},onsapend:function(v){v.setMarked();v.preventDefault();var w=this.getSelectableItems();var x=w[w.length-1];this.getListItem(x).focus();},onsapup:function(v){v.setMarked();v.preventDefault();var w=this.getSelectableItems();var x=w[0];var y=q(document.activeElement).control()[0];if(y===this.getListItem(x)){this.focus();v.stopPropagation(true);}},onfocusin:function(v){this.addStyleClass(this.getRenderer().CSS_CLASS_MULTICOMBOBOX+"Focused");},onfocusout:function(v){this.removeStyleClass(this.getRenderer().CSS_CLASS_MULTICOMBOBOX+"Focused");},onsapfocusleave:function(v){var w=this.getAggregation("picker");var x=p.byId(v.relatedControlId);if(w&&x&&m(w.getFocusDomRef(),x.getFocusDomRef())){if(v.srcControl){v.srcControl.focus();}}}},this);if(D.support.touch){i.addEventDelegate({ontouchstart:function(v){v.setMark("cancelAutoClose");}});}};u.prototype._handleInputFocusOut=function(){var i=this.isPickerDialog()?this.getPickerTextField():this,U=this._sOldInput||this._sOldValue||"";i.updateDomValue(U);};u.prototype._handleIndicatorPress=function(i){this._filterSelectedItems(i,true);this.focus();if(this.getEditable()){this.getPicker().open();}else{this._getReadOnlyPopover().openBy(this._oTokenizer._oIndicator);}if(this.isPickerDialog()){this._getFilterSelectedButton().setPressed(true);this.bOpenedByKeyboardOrButton=true;}else{setTimeout(this._oTokenizer["scrollToEnd"].bind(this._oTokenizer),0);}};u.prototype._createTokenizer=function(){var i=new T({tokens:[]}).attachTokenChange(this._handleTokenChange,this);i._setAdjustable(true);i._handleNMoreIndicatorPress(this._handleIndicatorPress.bind(this));i.setParent(this);i.addEventDelegate({onAfterRendering:this._onAfterRenderingTokenizer,onfocusin:function(v){if(this.getEditable()&&q(v.target).hasClass("sapMToken")){i._useCollapsedMode(false);}}},this);return i;};u.prototype._onAfterRenderingTokenizer=function(){setTimeout(this._oTokenizer["scrollToEnd"].bind(this._oTokenizer),0);};u.prototype._handleTokenChange=function(i){var v=i.getParameter("type");var w=i.getParameter("token");var x=null;if(v!==sap.m.Tokenizer.TokenChangeType.Removed&&v!==sap.m.Tokenizer.TokenChangeType.Added){return;}if(v===sap.m.Tokenizer.TokenChangeType.Removed){x=(w&&this._getItemByToken(w));if(x&&this.isItemSelected(x)){this.removeSelection({item:x,id:x.getId(),key:x.getKey(),tokenUpdated:true,fireChangeEvent:true,fireFinishEvent:true,suppressInvalidate:true});!this.isPickerDialog()&&this.focus();this.fireChangeEvent("");}}};u.prototype.onAfterRenderingList=function(){var i=this._getList();if(this._iFocusedIndex!=null&&i.getItems().length>this._iFocusedIndex){i.getItems()[this._iFocusedIndex].focus();this._iFocusedIndex=null;}};u.prototype.onFocusinList=function(){if(this._bListItemNavigationInvalidated){this._getList().getItemNavigation().setSelectedIndex(this._iInitialItemFocus);this._bListItemNavigationInvalidated=false;}};u.prototype.onAfterRendering=function(){a.prototype.onAfterRendering.apply(this,arguments);this._oTokenizer.setMaxWidth(this._calculateSpaceForTokenizer());this._registerResizeHandler();};u.prototype.onfocusout=function(i){this.isOpen()&&this._handleInputFocusOut();this.removeStyleClass("sapMFocus");if(this.getValueState()===V.Error&&this.getValueStateText()===this._oRbM.getText("VALUE_STATE_ERROR_ALREADY_SELECTED")){this.setValueState(V.None);}a.prototype.onfocusout.apply(this,arguments);};u.prototype.onpaste=function(i){var v;if(window.clipboardData){v=window.clipboardData.getData("Text");}else{v=i.originalEvent.clipboardData.getData('text/plain');}var w=this._oTokenizer._parseString(v);if(w&&w.length>0){this.getSelectableItems().forEach(function(x){if(w.indexOf(x.getText())>-1){this.setSelection({item:x,id:x.getId(),key:x.getKey(),fireChangeEvent:true,fireFinishEvent:true,suppressInvalidate:true,listItemUpdated:false});}},this);}};u.prototype.onsapbackspace=function(i){this._showAlreadySelectedVisualEffect();if(!this.getEnabled()||!this.getEditable()){i.preventDefault();return;}if(this.getCursorPosition()>0||this.getValue().length>0){return;}sap.m.Tokenizer.prototype.onsapbackspace.apply(this._oTokenizer,arguments);i.preventDefault();};u.prototype.onsapdelete=function(i){this._showAlreadySelectedVisualEffect();if(!this.getEnabled()||!this.getEditable()){return;}if(this.getValue()&&!this._isCompleteTextSelected()){return;}sap.m.Tokenizer.prototype.onsapdelete.apply(this._oTokenizer,arguments);};u.prototype.onsapnext=function(i){if(i.isMarked()){return;}var F=q(document.activeElement).control()[0];if(!F){return;}if(F===this._oTokenizer||this._oTokenizer.$().find(F.$()).length>0&&this.getEditable()){this.focus();}};u.prototype.onsapprevious=function(i){if(this.getCursorPosition()===0&&!this._isCompleteTextSelected()){if(i.srcControl===this){sap.m.Tokenizer.prototype.onsapprevious.apply(this._oTokenizer,arguments);}}};u.prototype.ontap=function(i){a.prototype.ontap.apply(this,arguments);var v=this.getOpenArea();if(!this.getEnabled()||!this.getEditable()){return;}i.setMarked();if(this.isPickerDialog()&&v.contains(i.target)){this.open();}};u.prototype.getOpenArea=function(){if(this.isPickerDialog()){return this.getDomRef();}else{return a.prototype.getOpenArea.apply(this,arguments);}};u.prototype._getItemsStartingWithPerTerm=function(i,v){var w=[],x=v?this.getEnabledItems():this.getSelectableItems(),F=this.fnFilter?this.fnFilter:a.DEFAULT_TEXT_FILTER;x.forEach(function(y){if(F(i,y,"getText")){w.push(y);}},this);return w;};u.prototype._getItemsStartingWith=function(i,v){var w=[],x=v?this.getEnabledItems():this.getSelectableItems();x.forEach(function(y){if(typeof i==="string"&&i!==""&&y.getText().toLowerCase().startsWith(i.toLowerCase())){w.push(y);}},this);return w;};u.prototype._getUnselectedItemsStartingText=function(i){var v=[];this._getUnselectedItems().forEach(function(w){if(typeof i==="string"&&i!==""&&w.getText().toLowerCase().startsWith(i.toLowerCase())){v.push(w);}},this);return v;};u.prototype.getCursorPosition=function(){return this._$input.cursorPos();};u.prototype._isCompleteTextSelected=function(){if(!this.getValue().length){return false;}var i=this._$input[0];if(i.selectionStart!==0||i.selectionEnd!==this.getValue().length){return false;}return true;};u.prototype._selectPreviousItemsOf=function(i){var v;do{v=true;var w=this._getPreviousVisibleItemOf(i);if(w){var x=this.getListItem(w);if(x){v=this.getListItem(w).getSelected();}}this.setSelection({item:i,id:i.getId(),key:i.getKey(),fireChangeEvent:true,suppressInvalidate:true});i=w;}while(!v);};u.prototype._getNextVisibleItemOf=function(i){var v=this.getSelectableItems();var w=v.indexOf(i)+1;if(w<=0||w>v.length-1){return null;}return v[w];};u.prototype._getPreviousVisibleItemOf=function(i){var v=this.getSelectableItems();var w=v.indexOf(i)-1;if(w<0){return null;}return v[w];};u.prototype._getNextUnselectedItemOf=function(i){var v=this._getUnselectedItems();var w=v.indexOf(i)+1;if(w<=0||w>v.length-1){return null;}return v[w];};u.prototype._getPreviousUnselectedItemOf=function(i){var v=this._getUnselectedItems();var w=v.indexOf(i)-1;if(w<0){return null;}return v[w];};u.prototype._getNextTraversalItem=function(){var v=this.getValue();var i=v?this._getItemsStartingWithPerTerm(v):[];var w=this._getUnselectedItems();if(i.indexOf(this._oTraversalItem)>-1&&this._oTraversalItem.getText()===this.getValue()){return this._getNextUnselectedItemOf(this._oTraversalItem);}if(i.length&&i[0].getText()===this.getValue()){return this._getNextUnselectedItemOf(i[0]);}return i.length?i[0]:w[0];};u.prototype._getPreviousTraversalItem=function(){var v=this.getValue();var i=v?this._getItemsStartingWithPerTerm(v):[];if(i.indexOf(this._oTraversalItem)>-1&&this._oTraversalItem.getText()===this.getValue()){return this._getPreviousUnselectedItemOf(this._oTraversalItem);}if(i.length&&i[i.length-1].getText()===this.getValue()){return this._getPreviousUnselectedItemOf(i[i.length-1]);}if(i.length){return i[i.length-1];}else{var w=this._getUnselectedItems();if(w.length>0){return w[w.length-1];}else{return null;}}};u.prototype.setSelectedItems=function(i){this.removeAllSelectedItems();if(!i||!i.length){return this;}if(!Array.isArray(i)){o.warning("Warning: setSelectedItems() has to be an array of sap.ui.core.Item instances or of valid sap.ui.core.Item IDs",this);return this;}i.forEach(function(v){if(!(v instanceof h)&&(typeof v!=="string")){o.warning("Warning: setSelectedItems() has to be an array of sap.ui.core.Item instances or of valid sap.ui.core.Item IDs",this);return;}if(typeof v==="string"){v=p.byId(v);}this.setSelection({item:v?v:null,id:v?v.getId():"",key:v?v.getKey():"",suppressInvalidate:true});},this);return this;};u.prototype.addSelectedItem=function(i){if(!i){return this;}if(typeof i==="string"){i=p.byId(i);}this.setSelection({item:i?i:null,id:i?i.getId():"",key:i?i.getKey():"",fireChangeEvent:false,suppressInvalidate:true});return this;};u.prototype.removeSelectedItem=function(i){if(!i){return null;}if(typeof i==="string"){i=p.byId(i);}if(!this.isItemSelected(i)){return null;}this.removeSelection({item:i,id:i.getId(),key:i.getKey(),fireChangeEvent:false,suppressInvalidate:true});return i;};u.prototype.removeAllSelectedItems=function(){var i=[];var v=this.getAssociation("selectedItems",[]);v.forEach(function(w){var x=this.removeSelectedItem(w);if(x){i.push(x.getId());}},this);return i;};u.prototype.removeSelectedKeys=function(i){var v=[],w;if(!i||!i.length||!Array.isArray(i)){return v;}var x;i.forEach(function(y){x=this.getItemByKey(y);if(x){this.removeSelection({item:x?x:null,id:x?x.getId():"",key:x?x.getKey():"",fireChangeEvent:false,suppressInvalidate:true});v.push(x);}if(this._aCustomerKeys.length&&(w=this._aCustomerKeys.indexOf(y))>-1){this._aCustomerKeys.splice(w,1);}},this);return v;};u.prototype.setSelectedKeys=function(i){this.removeAllSelectedItems();this._aCustomerKeys=[];this.addSelectedKeys(i);return this;};u.prototype.addSelectedKeys=function(i){i=this.validateProperty("selectedKeys",i);i.forEach(function(v){var w=this.getItemByKey(v);if(w){this.addSelectedItem(w);}else if(v!=null){this._aCustomerKeys.push(v);}},this);return this;};u.prototype.getSelectedKeys=function(){var i=this.getSelectedItems()||[],v=[];i.forEach(function(w){v.push(w.getKey());},this);if(this._aCustomerKeys.length){v=v.concat(this._aCustomerKeys);}return v;};u.prototype._getUnselectedItems=function(){var i=q(this.getSelectableItems()).not(this.getSelectedItems()).get();if(!this.isOpen()){return i.filter(function(v){return!v.isA("sap.ui.core.SeparatorItem");});}return i;};u.prototype.getSelectedItems=function(){var i=[],v=this.getAssociation("selectedItems")||[];v.forEach(function(w){var x=p.byId(w);if(x){i.push(x);}},this);return i;};u.prototype.getWidth=function(){return this.getProperty("width")||"100%";};u.prototype.setEditable=function(i){var v=this._getList();a.prototype.setEditable.apply(this,arguments);this._oTokenizer.setEditable(i);if(i){v.setMode(s.MultiSelect);this.getPicker().addContent(v);}else{v.setMode(s.None);this._getReadOnlyPopover().addContent(v);}return this;};u.prototype._mapItemToListItem=function(i){var v,w,x,A;var y=this.getRenderer();if(!i){return null;}A=(i.getAdditionalText&&this.getShowSecondaryValues())?i.getAdditionalText():"";if(i.isA("sap.ui.core.SeparatorItem")){v=this._mapSeparatorItemToGroupHeader(i,y);i.data(y.CSS_CLASS_COMBOBOXBASE+"ListItem",v);this._decorateListItem(v);return v;}w=y.CSS_CLASS_MULTICOMBOBOX+"Item";x=(this.isItemSelected(i))?w+"Selected":"";v=new S({type:r.Active,info:A,visible:i.getEnabled()}).addStyleClass(w+" "+x);v.setTooltip(i.getTooltip());i.data(y.CSS_CLASS_COMBOBOXBASE+"ListItem",v);v.setTitle(i.getText());if(x){var z=new c({key:i.getKey()});z.setText(i.getText());i.data(y.CSS_CLASS_COMBOBOXBASE+"Token",z);this._oTokenizer.addToken(z,true);}this.setSelectable(i,i.getEnabled());this._decorateListItem(v);return v;};u.prototype._findMappedItem=function(v,w){for(var i=0,w=w||this.getItems(),x=w.length;i<x;i++){if(this.getListItem(w[i])===v){return w[i];}}return null;};u.prototype.setSelectable=function(i,v){a.prototype.setSelectable.call(this,i,v);var w=this._getTokenByItem(i);if(w){w.setVisible(v);}};u.prototype._fillList=function(v){if(!v){return null;}if(!this._oListItemEnterEventDelegate){this._oListItemEnterEventDelegate={onsapenter:function(y){if(y.srcControl.isSelected()){y.setMarked();}}};}for(var i=0,w,x=v.length;i<x;i++){w=this._mapItemToListItem(v[i]);w.removeEventDelegate(this._oListItemEnterEventDelegate);w.addDelegate(this._oListItemEnterEventDelegate,true,this,true);this._getList().addAggregation("items",w,true);if(this.isItemSelected(v[i])){this._getList().setSelectedItem(w,true);}}};u.prototype.handleInputValidation=function(i,v){var w=i.target.value,x=this._sOldInput&&this._sOldInput.length>w.length,y=this.isValueValid(w),z,A,B;var F=i.srcControl;if(!y&&w!==""&&!v){this._handleFieldValidationState(F);return;}B=this._getItemsStartingWith(w,true);!v&&this._handleTypeAhead(w,B,F);z=this.getEnabledItems();if(this.isPickerDialog()){A=this._getFilterSelectedButton();if(A!=null&&A.getPressed()){A.setPressed(false);}}if(x){z=this.getItems();}this.filterItems({value:w,items:z});this._sOldInput=w;if((!this.getValue()||!y)&&!this.bOpenedByKeyboardOrButton&&!this.isPickerDialog()){this.close();}else{this.open();}};u.prototype.isValueValid=function(v){var i=this._getItemsStartingWith(v,true);var w=this._getItemsStartingWithPerTerm(v,true);return i.length||w.length;};u.prototype._handleTypeAhead=function(v,i,w){var x=this.getSelectedItems();var y=i.filter(function(z){if(z.isA("sap.ui.core.SeparatorItem")){return false;}return x.indexOf(z)===-1;});if(this._bDoTypeAhead&&y.length){w.updateDomValue(y[0].getText());if(document.activeElement===w.getFocusDomRef()){w.selectText(v.length,w.getValue().length);}}};u.prototype._handleFieldValidationState=function(i){if(this._sOldInput&&this.isValueValid(this._sOldInput)){i.updateDomValue(this._sOldInput);}else if(this._sOldValue&&this.isValueValid(this._sOldValue)){i.updateDomValue(this._sOldValue);}else{i.updateDomValue("");}if(this._iOldCursorPos){q(i.getFocusDomRef()).cursorPos(this._iOldCursorPos);}this._showWrongValueVisualEffect();};u.prototype.init=function(){this._oRb=p.getLibraryResourceBundle("sap.m");a.prototype.init.apply(this,arguments);this._bListItemNavigationInvalidated=false;this._iInitialItemFocus=-1;this._bCheckBoxClicked=true;this._bPreventValueRemove=false;this._oTokenizer=this._createTokenizer();this._aCustomerKeys=[];this._aInitiallySelectedItems=[];this._oRbM=p.getLibraryResourceBundle("sap.m");this._oRbC=p.getLibraryResourceBundle("sap.ui.core");this._fillList();};u.prototype.clearSelection=function(){this.removeAllSelectedItems();};u.prototype.insertItem=function(i,v){this.insertAggregation("items",i,v,true);if(i){i.attachEvent("_change",this.onItemChange,this);}if(this._getList()){this._getList().insertItem(this._mapItemToListItem(i),v);}return this;};u.prototype.removeItem=function(i){i=this.removeAggregation("items",i);if(this._getList()){this._getList().removeItem(i&&this.getListItem(i));}this.removeSelection({item:i,id:i?i.getId():"",key:i?i.getKey():"",fireChangeEvent:false,suppressInvalidate:true,listItemUpdated:true});return i;};u.prototype.isItemSelected=function(i){return this.getSelectedItems().indexOf(i)>-1;};u.prototype._clearTokenizer=function(){this._oTokenizer.destroyAggregation("tokens",true);};u.prototype.exit=function(){var i=["_oTokenizer","_oSuggestionPopover","_oToggleButton","_oPickerCustomHeader","_oCustomHeaderToolbar","_oPickerCloseButton"],v=this;a.prototype.exit.apply(this,arguments);this._deregisterResizeHandler();i.forEach(function(w){if(v[w]){v[w].destroy();v[w]=null;}});};u.prototype.destroyItems=function(){this.destroyAggregation("items");if(this._getList()){this._getList().destroyItems();}this._oTokenizer.destroyTokens();return this;};u.prototype.removeAllItems=function(){var i=this.removeAllAggregation("items");this.removeAllSelectedItems();if(this._getList()){this._getList().removeAllItems();}return i;};u.prototype._getItemByToken=function(i){return this._getItemBy(i,"Token");};u.prototype.getAccessibilityInfo=function(){var i=this.getSelectedItems().map(function(w){return w.getText();}).join(" ");var v=a.prototype.getAccessibilityInfo.apply(this,arguments);v.type=p.getLibraryResourceBundle("sap.m").getText("ACC_CTR_TYPE_MULTICOMBO");v.description=((v.description||"")+" "+i).trim();return v;};u.prototype.applyShowItemsFilters=function(){this.filterItems({value:this.getValue()||"_",items:this.getItems()});};return u;});
