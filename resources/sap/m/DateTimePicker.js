/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','./InputBase','./DatePicker','sap/ui/model/type/Date','sap/ui/unified/DateRange','./library','sap/ui/core/Control','sap/ui/Device','sap/ui/core/format/DateFormat','sap/ui/core/LocaleData','./DateTimePickerRenderer','./TimePickerSliders','./SegmentedButton','./SegmentedButtonItem','./ResponsivePopover','./Button',"sap/ui/events/KeyCodes","sap/ui/core/IconPool"],function(q,I,D,a,b,l,C,c,d,L,e,T,S,f,R,B,K,g){"use strict";var P=l.PlacementType;var h="Phone";var k=D.extend("sap.m.DateTimePicker",{metadata:{library:"sap.m",properties:{minutesStep:{type:"int",group:"Misc",defaultValue:1},secondsStep:{type:"int",group:"Misc",defaultValue:1}},aggregations:{_popup:{type:"sap.m.ResponsivePopover",multiple:false,visibility:"hidden"}},designtime:"sap/m/designtime/DateTimePicker.designtime",dnd:{draggable:false,droppable:true}}});var m=C.extend("sap.m.internal.DateTimePickerPopup",{metadata:{library:"sap.m",aggregations:{_switcher:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},calendar:{type:"sap.ui.core.Control",multiple:false},timeSliders:{type:"sap.ui.core.Control",multiple:false}}},renderer:function(i,j){i.write("<div");i.writeControlData(j);i.addClass("sapMDateTimePopupCont");i.addClass("sapMTimePickerDropDown");i.writeClasses();i.write(">");var t=j.getAggregation("_switcher");if(t){i.write("<div");i.addClass("sapMTimePickerSwitch");i.writeClasses();i.write(">");i.renderControl(t);i.write("</div>");}var u=j.getCalendar();if(u){i.renderControl(u);}i.write("<div");i.addClass("sapMTimePickerSep");i.writeClasses();i.write(">");i.write("</div>");var v=j.getTimeSliders();if(v){i.renderControl(v);}i.write("</div>");},init:function(){},onBeforeRendering:function(){var i=this.getAggregation("_switcher");if(!i){var j=sap.ui.getCore().getLibraryResourceBundle("sap.m");var t=j.getText("DATETIMEPICKER_DATE");var u=j.getText("DATETIMEPICKER_TIME");i=new S(this.getId()+"-Switch",{selectedKey:"Cal",items:[new f(this.getId()+"-Switch-Cal",{key:"Cal",text:t}),new f(this.getId()+"-Switch-Sli",{key:"Sli",text:u})]});i.attachSelect(this._handleSelect,this);this.setAggregation("_switcher",i,true);}if(c.system.phone||q('html').hasClass("sapUiMedia-Std-Phone")){i.setVisible(true);i.setSelectedKey("Cal");}else{i.setVisible(false);}},onAfterRendering:function(){if(c.system.phone||q('html').hasClass("sapUiMedia-Std-Phone")){var i=this.getAggregation("_switcher");var j=i.getSelectedKey();this._switchVisibility(j);}},_handleSelect:function(E){this._switchVisibility(E.getParameter("key"));},_switchVisibility:function(i){var j=this.getCalendar();var t=this.getTimeSliders();if(!j||!t){return;}if(i=="Cal"){j.$().css("display","");t.$().css("display","none");}else{j.$().css("display","none");t.$().css("display","");t._updateSlidersValues();t._onOrientationChanged();t.openFirstSlider();}},switchToTime:function(){var i=this.getAggregation("_switcher");if(i&&i.getVisible()){i.setSelectedKey("Sli");this._switchVisibility("Sli");}},getSpecialDates:function(){return this._oDateTimePicker.getSpecialDates();}});k.prototype.init=function(){D.prototype.init.apply(this,arguments);this._bOnlyCalendar=false;};k.prototype.getIconSrc=function(){return g.getIconURI("date-time");};k.prototype.exit=function(){D.prototype.exit.apply(this,arguments);if(this._oSliders){this._oSliders.destroy();delete this._oSliders;}this._oPopupContent=undefined;c.media.detachHandler(this._handleWindowResize,this);};k.prototype.setDisplayFormat=function(i){D.prototype.setDisplayFormat.apply(this,arguments);if(this._oSliders){this._oSliders.setDisplayFormat(r.call(this));}return this;};k.prototype.setMinutesStep=function(M){this.setProperty('minutesStep',M,true);if(this._oSliders){this._oSliders.setMinutesStep(M);}return this;};k.prototype.setMinDate=function(i){D.prototype.setMinDate.call(this,i);if(i){this._oMinDate.setHours(i.getHours(),i.getMinutes(),i.getSeconds());}return this;};k.prototype.setMaxDate=function(i){D.prototype.setMaxDate.call(this,i);if(i){this._oMaxDate.setHours(i.getHours(),i.getMinutes(),i.getSeconds());}return this;};k.prototype.setSecondsStep=function(i){this.setProperty('secondsStep',i,true);if(this._oSliders){this._oSliders.setSecondsStep(i);}return this;};k.prototype._getFormatInstance=function(A,i){var M=q.extend({},A);var j=-1;if(M.style){j=M.style.indexOf("/");}if(i){var t=q.extend({},M);if(j>0){t.style=t.style.substr(0,j);}this._oDisplayFormatDate=d.getInstance(t);}return d.getDateTimeInstance(M);};k.prototype._checkStyle=function(t){if(D.prototype._checkStyle.apply(this,arguments)){return true;}else if(t.indexOf("/")>0){var u=["short","medium","long","full"];var v=false;for(var i=0;i<u.length;i++){var w=u[i];for(var j=0;j<u.length;j++){var x=u[j];if(t==w+"/"+x){v=true;break;}}if(v){break;}}return v;}return false;};k.prototype._parseValue=function(v,i){var j=D.prototype._parseValue.apply(this,arguments);if(i&&!j){j=this._oDisplayFormatDate.parse(v);if(j){var O=this.getDateValue();if(!O){O=new Date();}j.setHours(O.getHours());j.setMinutes(O.getMinutes());j.setSeconds(O.getSeconds());j.setMilliseconds(O.getMilliseconds());}}return j;};k.prototype._getLocaleBasedPattern=function(i){var j=L.getInstance(sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale()),t=i.indexOf("/");if(t>0){return j.getCombinedDateTimePattern(i.substr(0,t),i.substr(t+1));}else{return j.getCombinedDateTimePattern(i,i);}};k.prototype._createPopup=function(){if(!this._oPopup){var i=sap.ui.getCore().getLibraryResourceBundle("sap.m");var O=i.getText("TIMEPICKER_SET");var j=i.getText("TIMEPICKER_CANCEL");this._oPopupContent=new m(this.getId()+"-PC");this._oPopupContent._oDateTimePicker=this;this._oPopup=new R(this.getId()+"-RP",{showCloseButton:false,showHeader:false,placement:P.VerticalPreferedBottom,beginButton:new B(this.getId()+"-OK",{text:O,press:q.proxy(_,this)}),endButton:new B(this.getId()+"-Cancel",{text:j,press:q.proxy(n,this)}),content:this._oPopupContent});this._oPopup.addStyleClass("sapMDateTimePopup");var t=this._oPopup.getAggregation("_popup");if(t.setShowArrow){t.setShowArrow(false);}this._oPopup.attachAfterOpen(o,this);this._oPopup.attachAfterClose(p,this);if(c.system.desktop){this._oPopoverKeydownEventDelegate={onkeydown:function(E){var u=K,v=E.which||E.keyCode,A=E.altKey;if((A&&(v===u.ARROW_UP||v===u.ARROW_DOWN))||v===u.F4){_.call(this,E);this.focus();E.preventDefault();}}};this._oPopup.addEventDelegate(this._oPopoverKeydownEventDelegate,this);}this.setAggregation("_popup",this._oPopup,true);}};k.prototype._openPopup=function(){if(!this._oPopup){return;}this.addStyleClass(I.ICON_PRESSED_CSS_CLASS);this._storeInputSelection(this._$input.get(0));var i=this._oPopup.getAggregation("_popup");i.oPopup.setAutoCloseAreas([this.getDomRef()]);this._oPopup.openBy(this);var j=this._oPopup.getContent()[0]&&this._oPopup.getContent()[0].getTimeSliders();if(j){setTimeout(j._updateSlidersValues.bind(j),0);}};k.prototype._createPopupContent=function(){var N=!this._oCalendar;D.prototype._createPopupContent.apply(this,arguments);if(N){this._oPopupContent.setCalendar(this._oCalendar);this._oCalendar.attachSelect(s,this);var t=this,H=this._oCalendar._hideMonthPicker,i=this._oCalendar._hideYearPicker;this._oCalendar._hideMonthPicker=function(j){H.apply(this,arguments);if(!j){t._selectFocusedDateValue(new b().setStartDate(this._getFocusedDate().toLocalJSDate()));}};this._oCalendar._hideYearPicker=function(j){i.apply(this,arguments);if(!j){t._selectFocusedDateValue(new b().setStartDate(this._getFocusedDate().toLocalJSDate()));}};}if(!this._oSliders){this._oSliders=new T(this.getId()+"-Sliders",{minutesStep:this.getMinutesStep(),secondsStep:this.getSecondsStep(),displayFormat:r.call(this),localeId:this.getLocaleId()})._setShouldOpenSliderAfterRendering(true);this._oPopupContent.setTimeSliders(this._oSliders);}};k.prototype._selectFocusedDateValue=function(i){var j=this._oCalendar;j.removeAllSelectedDates();j.addSelectedDate(i);return this;};k.prototype._fillDateRange=function(){var i=this.getDateValue();if(i){i=new Date(i.getTime());}else{i=this._getInitialFocusedDateValue();var M=this._oMaxDate.getTime();if(i.getTime()<this._oMinDate.getTime()||i.getTime()>M){i=this._oMinDate;}}this._oCalendar.focusDate(i);if(!this._oDateRange.getStartDate()||this._oDateRange.getStartDate().getTime()!=i.getTime()){this._oDateRange.setStartDate(i);}this._oSliders._setTimeValues(i);};k.prototype._getSelectedDate=function(){var i=D.prototype._getSelectedDate.apply(this,arguments);if(i){var j=this._oSliders.getTimeValues();var t=this._oSliders._getDisplayFormatPattern();if(t.search("h")>=0||t.search("H")>=0){i.setHours(j.getHours());}if(t.search("m")>=0){i.setMinutes(j.getMinutes());}if(t.search("s")>=0){i.setSeconds(j.getSeconds());}if(i.getTime()<this._oMinDate.getTime()){i=new Date(this._oMinDate.getTime());}else if(i.getTime()>this._oMaxDate.getTime()){i=new Date(this._oMaxDate.getTime());}}return i;};k.prototype._getInitialFocusedDateValue=function(){return this.getInitialFocusedDateValue()||new Date();};k.prototype.getLocaleId=function(){return sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().toString();};k.prototype.getAccessibilityInfo=function(){var i=D.prototype.getAccessibilityInfo.apply(this,arguments);i.type=sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("ACC_CTR_TYPE_DATETIMEINPUT");return i;};function _(E){this._selectDate();}function n(E){this.onsaphide(E);this._oCalendar.removeAllSelectedDates();this._oCalendar.addSelectedDate(new b().setStartDate(this._getInitialFocusedDateValue()));}k.prototype._handleWindowResize=function(i){var j=this.getAggregation("_popup").getContent()[0].getAggregation("_switcher"),t=this.getAggregation("_popup").getContent()[0].getCalendar(),u=this.getAggregation("_popup").getContent()[0].getTimeSliders();if(i.name===h){j.setVisible(true);this.getAggregation("_popup").getContent()[0]._switchVisibility(j.getSelectedKey());}else{j.setVisible(false);u.$().css("display","");t.$().css("display","");}};function o(E){this.$("inner").attr("aria-expanded",true);this._oCalendar.focus();this._oSliders._onOrientationChanged();c.media.attachHandler(this._handleWindowResize,this);}function p(){this.removeStyleClass(I.ICON_PRESSED_CSS_CLASS);this.$("inner").attr("aria-expanded",false);this._restoreInputSelection(this._$input.get(0));c.media.detachHandler(this._handleWindowResize,this);}function r(){var i=this.getDisplayFormat();var t;var j=this.getBinding("value");if(j&&j.oType&&(j.oType instanceof a)){i=j.oType.getOutputPattern();}else if(j&&j.oType&&j.oType.oFormat){i=j.oType.oFormat.oFormatOptions.pattern;}else{i=this.getDisplayFormat();}if(!i){i="medium";}var u=i.indexOf("/");if(u>0&&this._checkStyle(i)){i=i.substr(u+1);}if(i=="short"||i=="medium"||i=="long"||i=="full"){var v=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var w=L.getInstance(v);t=w.getTimePattern(i);}else{t=i;}return t;}function s(E){this._oPopupContent.switchToTime();}return k;});
